{% extends "base.html" %}
{% set current_step = 1 %}
{% block content %}

{% if not uploaded %}
<p> De snelste manier om tot invulformulieren te komen is door een zogenaamd EDEXML-bestand  te uploaden.
  Deze kun je uit alle bekende leerlingadministratiesystemen downloaden. <a href="https://www.google.com/search?q=edexml+exporteren"
     target="_blank"
     rel="noopener noreferrer"
     aria-label="Zoek op Google: hoe uploaden EDEXML bestand invulformulieren leerlingadministratie">
    Zoek hoe je dat kunt doen (Google)
  </a>. Selecteer de versie 2.1. Er hoeven geen privacy-gevoelige gegevens te worden geexporteerd.
In het volgende scherm kun je dan controleren of het allemaal klopt.
</p>
<form method="post" enctype="multipart/form-data">
    <label for="edexml">EDEXML:</label><br>
    <input type="file" name="edexml" accept=".xml" required><br><br>
    <label for="jaargroep"> jaargroep die moet worden ingedeeld</label>
    <select name="jaargroep" required>
        {% for year in range(1, 9) %}
        <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="button">Selecteer leerlingen en groepen</button>
    <br><br>
    </form>
{% else %}


  <h2>Selecteer leerlingen die doorgaan</h2>
  <p>Vink aan wie naar de volgende groep gaan. Verlengers kunnen uitgevinkt worden. Als er nog leerlingen missen kun je die onderaan toevoegen</p>
  <form method="post">
    {% for student in candidates %}
      <label>
        <input type="checkbox" name="students" value="{{ student.key }}" checked>
        {{ student.roepnaam }} {{ student.achternaam }} ({{ student.groepsnaam }})
      </label>
    {% endfor %}

    <div id="new-students">
    </div>
    <button type="button" onclick="addStudentField()">+ Voeg leerling toe</button>
<h2>Selecteer groepen waar ze naar toe gaan</h2>
<p>Met vinkjes kun je aangeven wie achterblijven in de groepen. Deze worden automatisch geteld in de jongens/meisjes-verdeling in de groepen.
  Als er nog leerlingen missen, kun je die telling in het excel aanpassen. Onderaan kun je ook nog een groepsnaam toevoegen als die mist.</p>
  <div id="groups-to">
    {% for groupname, students in groups_to.items()%}
      <div class="group-block">
        <strong>{{ groupname }}</strong>
          <ul>
            {% for s in students %}
              <li>
                <label>
                  <input type="checkbox" name="group_students[{{ groupname }}]" value="{{ s.geslacht }}" {% if s.blijft_in_groep %}checked{% endif %}>
                  {{ s.roepnaam }} {{ s.achternaam }} ({{s.jaargroep}})
                </label>
              </li>
            {% endfor %}
          </ul>
      </div>
    {% endfor %}
  </div>

  <div id="new-groups">
  </div>
  <button type="button" onclick="addGroupField()">+ Nog een groep</button>

    <br><br>
    <button type="submit" class="button">Genereer invulformulieren</button>
  </form>
<script>
const groupOptions = `{% for g in groups_from %}<option value="{{ g }}">{{ g }}</option>{% endfor %}`;

function addStudentField() {
  const container = document.getElementById("new-students");
  const row = document.createElement("div");
  row.className = "student-row";
  row.innerHTML = `
    <input type="text" name="new_firstname[]" placeholder="Voornaam" required>
    <input type="text" name="new_lastname[]" placeholder="Achternaam" required>
    <select name="new_gender[]" required>
      <option value="Jongen">Jongen</option>
      <option value="Meisje">Meisje</option>
    </select>
    <select name="new_group[]" required>
        ${groupOptions}
    </select>
  `;
  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "✖";
  removeBtn.onclick = () => row.remove();

  row.appendChild(removeBtn);
  container.appendChild(row);
}

function addGroupField() {
  const container = document.getElementById("new-groups");
  const row = document.createElement("div");
  row.className = "group-row";

  const input = document.createElement("input");
  input.type = "text";
  input.name = "new_groups[]";
  input.placeholder = "Groepsnaam";
  input.required = true;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "✖";
  removeBtn.style.cursor = "pointer";
  removeBtn.onclick = () => row.remove();

  row.appendChild(input);
  row.appendChild(removeBtn);
  container.appendChild(row);
}

</script>
<style>
  .student-row {
    display: flex;
    gap: 10px;
    /* margin-bottom: 5px; */
  }
  .student-row input, .student-row select {
    flex: 1;
  }
  .student-row button {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 16px;
    color: red;
  }

  .group-row {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 5px;
  }

  .group-row input {
    flex: 1;
  }

  .group-row button {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 16px;
    color: red;
  }
</style>

{% endif %}


<div class="instructions-box">
    <h2>Invulinstructies</h2>

    <h3>Voorkeuren-bestand</h3>
    <p>
        Dit is het belangrijkste bestand van ALI Express. Hier kun je basisinformatie over je leeringen invoeren
        (die wordt gebruikt om de balans in de groepen te bewaren) en de wensen van de leerling op basis van het
        gesprek.
        Wat specifieke tips:
    <ul>
        <li> Klik op een kolomnaam voor meer informatie over hoe je het moet invullen</li>
        <li> Controleer dat de naam van de leerling uniek is voor de leerlingen die verdeel moeten worden. Zo niet, voeg
            de eerste letter van de achternaam toe</li>
        <li>Vul minimale tevredenheid alleen in alsdeze leerling echt een zetje nodig heeft. Houd er
            rekening mee dat elke eis hier ten koste gaat van iemands anders tevredenheid.
        </li>
        <li>Denk hier echt aan wat de leerling wil. Onwenselijke combinaties kun je in het Niet-samen-bestand invoeren.
            Ook als iets jou een goede combi lijkt: laat dat aan ALI Express, die weegt alles mee</li>
        <li>
            Voer zoveel mogelijk positieve wensen in. Dat geeft ALI Express meer flexibiliteit om voor iedereen een
            prima oplossing te vinden.
        </li>
        <li>
            Voer hier precies de naam van de leerling of van de groep in. Dus niet "Robin (Blauw)", maar "Blauw" of
            "Robin" of "Jongens zoals Rene"
        </li>

        <li> Check of je alle kolommen hebt ingevuld, en of je passende gewichten hebt ingevuld</li>
    </ul>
    </p>
    <h3>Groepen-bestand</h3>
    <p>Geef hier in naar welke groepen de leerlingen kunnen, en hoeveel jongens en meisjes er overblijven
        nadat de oudere leerlingen zijn doorgegaan. Dat laatste zorgt er voor dat de balans goed kan worden bewaard,
        qua grootte en jongen/meisjes.
    </p>
    <h3>Niet-samen-bestand</h3>
    <p>In dit bestand kan per regel worden weergegeven wie er helemaal niet of niet in te grote groepen bij elkaar
        mogen. Je kunt hier denken aan kinderen die elkaar negatief versterken of zorgleerlingen die je wilt scheiden
        om passende aandacht te kunnen geven. Houd er rekening mee dat eisen die je hier invult, de groepsindeling
        moeilijker
        maken en daardoor zullen leiden tot een lagere tevredenheid.

        Alle namen moeten voorkomen in het voorkeuren-bestand.
        Als je bijvoorbeeld twee leerlingen niet bij elkaar wilt, vul je die namen in bij Leerling1 en Leerling 2, en
        max_aantal_samen 1: ze mogen dan niet samen in een groep.
        Je zou ook de 10 zorgleerlingen kunnen invoeren en dan aangeven dat er daarvan maximaal 2 in een groep mogen.
    </p>
</div>


<div class="step-navigation">
    <a href="{{ url_for('upload_files') }}" class="button next-step">Ik heb de invulformulieren <br>Naar uploaden →</a>
</div>

</div>
{% endblock %}